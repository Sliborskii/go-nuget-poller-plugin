<project name="go-nuget-poller" default="all">

    <property name="cruise.dir" value="/home/vagrant/cruise"/>
    <property name="cruise.go.api.dir" value="/vagrant/go-nuget-poller/sdk"/>
    <property name="go.api.jar.name" value="go-plugin-api-13.3.0.jar"/>
    <property name="cruise.go.api.jar" value="${cruise.go.api.dir}/${go.api.jar.name}"/>
    <property name="target.dir" value="target"/>
    <property name="dist.dir" value="dist"/>
    <property name="test.reports.dir" value="reports"/>

    <taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask">
        <classpath>
            <path id="junit.test">
                <fileset dir="." includes="tools/apache-ant-1.9.0/ant-junit.jar, lib/junit*.jar"/>
            </path>
        </classpath>
    </taskdef>

    <path id="compile.classpath">
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="${cruise.go.api.jar}"/>
    </path>

    <target name="all" depends="clean, compile.source, compile.test, test, dist"/>

    <target name="clean">
        <delete dir="${target.dir}" description="Deletes the target directory"/>
        <delete dir="${dist.dir}" description="Deletes the dist directory"/>
        <delete dir="${test.reports.dir}" description="Deletes the test reports directory"/>
    </target>


    <target name="prepare" depends="clean">
        <mkdir dir="${target.dir}"/>
        <mkdir dir="${target.dir}/src"/>
        <mkdir dir="${target.dir}/test"/>
        <mkdir dir="${test.reports.dir}"/>
    </target>

    <target name="compile.source" depends="prepare">
        <javac srcdir="src" destdir="${target.dir}/src" classpathref="compile.classpath" includeantruntime="false" source="1.6"/>
    </target>

    <target name="compile.test" depends="compile.source">
        <javac srcdir="test" destdir="${target.dir}/test" includeantruntime="false">
            <classpath refid="compile.classpath"/>
            <classpath location="${target.dir}/src"/>
        </javac>
    </target>

    <target name="test" depends="compile.test">
        <junit failureproperty="test.failed">
            <classpath>
                <path refid="compile.classpath"/>
                <pathelement location="${target.dir}/src"/>
                <pathelement location="${target.dir}/test"/>
            </classpath>
            <formatter type="plain"/>
            <batchtest fork="yes" todir="${test.reports.dir}">
                <fileset dir="test">
                    <include name="**/*Test*.java"/>
                </fileset>
            </batchtest>
        </junit>
        <fail message="Test failure detected, check test results." if="test.failed"/>
    </target>

    <target name="dist" depends="compile.source">
        <mkdir dir="${target.dir}/src/lib"/>
        <copy todir="${target.dir}/src/lib" flatten="true">
            <fileset dir="lib">
                <exclude name="junit*.jar"/>
                <exclude name="mockito*.jar"/>
                <include name="*.jar"/>
            </fileset>
        </copy>
        <basename property="jar.name" file="${basedir}"/>
        <copy file="plugin.xml" todir="${target.dir}/src"/>
        <mkdir dir="${dist.dir}"/>
        <jar basedir="${target.dir}/src" destfile="${dist.dir}/${jar.name}.jar"/>
    </target>
</project>
